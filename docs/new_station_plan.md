# 新地铁站场景开发计划

---

## ⚠️ 核心设计原则

> **最重要的设计约束：小流量训练的模型必须能直接用于大流量场景，所有模型都必须遵循此原则。**

### 原则一：模型泛化性约束

| 约束 | 说明 |
|------|------|
| **训练规模** | 在小流量（1000人）场景训练 |
| **应用规模** | 必须能直接用于中流量（2000人）和大流量（3000人）场景 |
| **不允许** | 针对每种流量单独训练模型 |

### 原则二：归一化是关键

为实现模型泛化，所有设计必须遵循：

1. **观测空间归一化**：所有观测值必须是相对值（比例），而非绝对值（人数）
2. **奖励信号归一化**：奖励基于疏散比例，而非绝对疏散人数
3. **阈值动态化**：所有阈值相对于总人数计算

### 原则三：设计一致性

| 要素 | 要求 |
|------|------|
| 出口数量 | 所有流量等级使用相同出口配置 |
| 场景布局 | 所有流量等级使用相同场景 |
| 行人类型分布 | 所有流量等级使用相同比例 |
| 观测维度 | 固定41维，不随人数变化 |

### 验证标准

模型训练完成后必须通过以下验证：

```bash
# 用小流量训练的模型测试所有流量等级
python examples/train_ppo_large_station.py --scale-test outputs/models/ppo_large_station_small.zip
```

| 流量等级 | 疏散率要求 | 最大密度要求 |
|----------|-----------|-------------|
| 小（1000人） | ≥ 95% | < 4.0 人/m² |
| 中（2000人） | ≥ 90% | < 4.0 人/m² |
| 大（3000人） | ≥ 85% | < 4.5 人/m² |

---

## 场景概述

### 基本参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 场景尺寸 | 150m × 80m | 东西向 × 南北向（T形结构） |
| 层高 | 4.5-5.0m | 站厅层 |
| 面积 | 12000 m² | T形布局 |

### 设施清单

| 设施类型 | 编号/位置 | 数量 | 紧急模式 |
|----------|----------|------|----------|
| 步梯 | 左上、左下 | 2个 | ⬆️ 只进不出（涌入点） |
| 扶梯 | 左上、左下（与步梯并列） | 2组 | ⬆️ 只进不出（涌入点） |
| 扶梯 | 中间区域 | 3组 | ⬆️ 只进不出（涌入点） |
| 直升电梯 | 左侧中间 | 1个 | ❌ **禁用** |
| 闸机a | 左侧(垂直) | 1组 | ✅ **疏散出口** |
| 闸机子 | 右侧(垂直) | 1组 | ✅ **疏散出口** |
| 闸机b/c/d | 上排(水平) | 3组 | ✅ **疏散出口** |
| 闸机e/f/g | 下排(水平) | 3组 | ✅ **疏散出口** |

> **涌入点总数**: 7个（2步梯 + 5扶梯）

---

## 一、行人类型扩展

### 1.1 当前行人类型

```python
PedestrianType:
  - NORMAL     # 普通成人
  - ELDERLY    # 老人
  - CHILD      # 儿童
  - IMPATIENT  # 急躁型
```

### 1.2 新增：带行李行人

#### 完整参数表

| 类型 | 期望速度 | 速度标准差 | 半径 | 反应时间 | 颜色 |
|------|----------|-----------|------|----------|------|
| `WITH_SMALL_BAG` | 1.2 m/s | 0.2 | 0.35m | 0.5s | cyan |
| `WITH_LUGGAGE` | 0.9 m/s | 0.15 | 0.5m | 0.6s | orange |
| `WITH_LARGE_LUGGAGE` | 0.7 m/s | 0.1 | 0.6m | 0.7s | purple |

#### 行李类型说明

| 类型 | 典型场景 | 行李示例 |
|------|----------|----------|
| **小包** | 日常通勤、短途出行 | 背包、手提包、公文包 |
| **拉杆箱** | 出差、短途旅行 | 20-24寸拉杆箱 |
| **大行李** | 长途旅行、搬家 | 28寸以上行李箱、大包裹 |

#### 行李对行人行为的影响

| 影响因素 | `WITH_SMALL_BAG` | `WITH_LUGGAGE` | `WITH_LARGE_LUGGAGE` |
|----------|-----------------|----------------|---------------------|
| 速度降低 | 10% | 33% | 48% |
| 占用空间增加 | 17% | 67% | 100% |
| 反应时间增加 | 0% | 20% | 40% |
| 转向灵活性 | 高 | 中 | 低 |
| 通过闸机难度 | 低 | 中 | 高 |

#### 特殊行为规则

1. **闸机通行**：
   - `WITH_LARGE_LUGGAGE` 行人通过闸机时间 +50%
   - `WITH_LUGGAGE` 行人通过闸机时间 +25%

2. **扶梯通行**：
   - 大行李行人占用扶梯 2 个站位
   - 拉杆箱行人占用扶梯 1.5 个站位

3. **拥挤时行为**：
   - 大行李行人更容易形成瓶颈
   - 小包行人可以适当挤压通过

### 1.3 行人类型分布 ✅

> ⚠️ **泛化性要求**：所有流量等级必须使用相同的类型分布比例，确保模型能泛化。

**日常模式**（默认）：
```yaml
pedestrian_distribution:
  NORMAL: 0.40          # 40% 普通
  ELDERLY: 0.10         # 10% 老人
  CHILD: 0.05           # 5% 儿童
  IMPATIENT: 0.05       # 5% 急躁
  WITH_SMALL_BAG: 0.25  # 25% 小包
  WITH_LUGGAGE: 0.12    # 12% 拉杆箱
  WITH_LARGE_LUGGAGE: 0.03  # 3% 大行李
```

**高峰模式**（通勤为主）：
```yaml
pedestrian_distribution:
  NORMAL: 0.50
  IMPATIENT: 0.15
  WITH_SMALL_BAG: 0.30
  WITH_LUGGAGE: 0.05
```

#### 不同流量下的人数分布（日常模式）

| 类型 | 小流量(1000人) | 中流量(2000人) | 大流量(3000人) |
|------|---------------|---------------|---------------|
| 普通 | 400 | 800 | 1200 |
| 老人 | 100 | 200 | 300 |
| 儿童 | 50 | 100 | 150 |
| 急躁 | 50 | 100 | 150 |
| 小包 | 250 | 500 | 750 |
| 拉杆箱 | 120 | 240 | 360 |
| 大行李 | 30 | 60 | 90 |

#### 平均行人参数（加权）

| 参数 | 计算值 |
|------|--------|
| 平均速度 | 1.15 m/s |
| 平均半径 | 0.36 m |
| 平均反应时间 | 0.54 s |

---

## 二、人流量设置

### 2.1 双层人流模型

人流分为**上层（本层已有）**和**下层（从扶梯涌入）**两部分：

```
                    ┌──────────────────────────┐
                    │      上层人流            │
                    │   (本层已有，等待出站)    │
                    └──────────────────────────┘
                              ↑
                    ┌──────────────────────────┐
                    │      下层人流            │
                    │  (从扶梯持续涌入)        │
                    └──────────────────────────┘
```

### 2.2 人流量等级定义 ✅

| 等级 | 上层人数 | 下层人数 | **总人数** | 密度 |
|------|---------|---------|-----------|------|
| **小** | 500人 | 500人 | **1000人** | 0.11人/m² |
| **中** | 1000人 | 1000人 | **2000人** | 0.22人/m² |
| **大** | 1500人 | 1500人 | **3000人** | 0.33人/m² |

### 2.3 人流生成逻辑

#### 上层人流（初始生成）
- **生成时机**：仿真开始时一次性生成
- **生成位置**：
  - 闸机区域内（等待过闸）
  - 中间通道（行走中）
  - 扶梯附近（刚到达）

#### 下层人流（持续涌入）
- **生成时机**：仿真过程中持续从扶梯口生成
- **生成位置**：3个扶梯出口
- **生成速率**：根据扶梯通行能力（约60人/分钟/扶梯）

```python
# 人流生成配置示例
FLOW_CONFIG = {
    "small": {
        "upper_layer": 500,      # 上层初始人数
        "lower_layer": 500,      # 下层总涌入人数
        "spawn_rate": 3.0,       # 每秒从扶梯涌入人数
    },
    "medium": {
        "upper_layer": 1000,
        "lower_layer": 1000,
        "spawn_rate": 5.0,
    },
    "large": {
        "upper_layer": 1500,
        "lower_layer": 1500,
        "spawn_rate": 8.0,
    },
}
```

### 2.4 人流生成区域

```
场景尺寸: 150m × 80m (T形结构)
坐标原点: 左下角 (0, 0)

                           Y=80
    ┌─────────────────┐
    │ 步梯  扶梯       │ (左上角区域 X:0-20, Y:65-80)
    │                 ├────────────────────────────────────────────┐
    │                 │      闸机b        闸机c        闸机d        │ Y=70
    │ 闸机a           │     (X:45-60)   (X:75-90)   (X:105-120)    │
Y=40│ (疏散口)        │                                     闸机子 │ Y=40
    │ (X:0, Y:30-50)  │     ┌────┐      ┌────┐      ┌────┐ (疏散口)│
    │                 │     │扶梯1│      │扶梯2│      │扶梯3│        │
    │ 直升电梯(禁用)   │     │涌入 │      │涌入 │      │涌入 │        │
    │ (X:20, Y:26-34) │     └────┘      └────┘      └────┘        │
    │                 │      闸机e        闸机f        闸机g        │ Y=10
    │ 步梯  扶梯       ├────────────────────────────────────────────┘
    │                 │ (左下角区域 X:0-20, Y:0-15)
    └─────────────────┘
                           Y=0                                   X=150

图例：
✅ 闸机 = 唯一疏散出口（8组）
⬆️ 扶梯 = 下层人员涌入点（5个，只进不出）
⬆️ 步梯 = 下层人员涌入点（2个，只进不出）
❌ 电梯 = 紧急模式禁用

**涌入点总数**: 7个（5扶梯 + 2步梯）
```

### 2.5 疏散出口（紧急模式）

| 设施 | 位置 | 通行能力 | 紧急模式状态 |
|------|------|----------|--------------|
| **闸机a** | 左侧 | ~100人/分钟 | ✅ 疏散出口 |
| **闸机子** | 右侧 | ~100人/分钟 | ✅ 疏散出口 |
| **闸机b/c/d** | 上排 | ~150人/分钟×3 | ✅ 疏散出口 |
| **闸机e/f/g** | 下排 | ~150人/分钟×3 | ✅ 疏散出口 |
| 扶梯-左上 | 左上角 | ~60人/分钟 | ⬆️ 只进不出（涌入点） |
| 扶梯-左下 | 左下角 | ~60人/分钟 | ⬆️ 只进不出（涌入点） |
| 扶梯-中1/2/3 | 中间区域 | ~60人/分钟×3 | ⬆️ 只进不出（涌入点） |
| 步梯-左上 | 左上角 | ~40人/分钟 | ⬆️ 只进不出（涌入点） |
| 步梯-左下 | 左下角 | ~40人/分钟 | ⬆️ 只进不出（涌入点） |
| 直升电梯 | 左侧中间 | - | ❌ 禁用 |

**总疏散能力**: 8组闸机 ≈ **800人/分钟**

### 2.6 关键挑战

| 人流等级 | 总人数 | 理论疏散时间 | 挑战 |
|----------|--------|-------------|------|
| 小 | 1000人 | ~2分钟 | 低 |
| 中 | 2000人 | ~3分钟 | 中（涌入压力） |
| 大 | 3000人 | ~4分钟 | 高（持续涌入+高密度） |

**核心难点**：
- 下层人员通过扶梯和步梯持续涌入本层（7个涌入点），无法阻止
- 所有扶梯和步梯**只进不出**，不可反向疏散
- 疏散速度必须 > 涌入速度，否则本层人数持续增加
- 唯一疏散通道为8组闸机

---

## 三、障碍物分布

### 3.1 固定障碍物

| 类型 | 位置 | 尺寸 | 说明 |
|------|------|------|------|
| 场景边界墙 | 四周 | - | 不可穿越 |
| 扶梯护栏 | 扶梯两侧 | 1m高 | 边界 |
| 引导围栏 | 待配置 | 可变 | 疏散引导（位置固定） |
| 临时围栏 | 待配置 | 可变 | 区域隔离（位置固定） |

> ⚠️ **疏散模式下**：所有闸机完全打开，可直接通过（无通行限制）
>
> ⚠️ **不存在的设施**：无承重柱、无服务台、无自动售票机

### 3.2 可变障碍物

> ⚠️ **重要约束**：围栏在疏散过程中**位置不可变化**，仅在初始化时配置。

**配置选项**：
```yaml
obstacles:
  guide_barriers: 4      # 引导围栏（帮助分流）
  temporary_barriers: 2  # 临时围栏（区域隔离）
```

**不包含**：无广告柱、无服务台、无自动售票机

### 3.3 已确认事项 ✅

- [x] 无立柱（承重柱）
- [x] 无自动售票机
- [x] 无服务台
- [x] 无其他固定设施
- [x] 仅考虑引导围栏和临时围栏，且位置不可在疏散中变化

---

## 四、紧急模式逻辑 ✅

### 4.1 核心约束

```
┌────────────────────────────────────────────────────────────────┐
│                        本层 (站厅层)                            │
│                                                                │
│   ┌─────┐                                        ┌─────┐       │
│   │闸机a│  ←────── 疏散方向 ──────→              │闸机子│      │
│   │出口 │         (唯一疏散通道)                 │出口  │      │
│   └─────┘                                        └─────┘       │
│                                                                │
│            [扶梯1↑]   [扶梯2↑]   [扶梯3↑]                       │
│               ↑          ↑          ↑                          │
│               │          │          │                          │
│          下层人员持续涌入（不可阻止）                            │
│                                                                │
└────────────────────────────────────────────────────────────────┘

关键约束：
1. 扶梯和步梯只能 下层→本层（只进不出，不能反向疏散）
2. 电梯紧急情况下禁用
3. 闸机是唯一疏散通道（8组）
4. 涌入点共7个（5扶梯 + 2步梯）
```

### 4.2 设施状态（紧急模式）

| 设施 | 状态 | 说明 |
|------|------|------|
| **闸机×8** | ✅ 完全开放 | **唯一疏散出口**（所有行人从闸机疏散出场地） |
| **扶梯×5** | ⬆️ 只进不出 | **下层人员涌入点**（下层→本层，不可反向） |
| **步梯×2** | ⬆️ 只进不出 | **下层人员涌入点**（下层→本层，不可反向） |
| **直升电梯** | ❌ 禁用 | 紧急情况下不可使用 |

#### 疏散流程
```
下层人员 → 扶梯(只上) → 本层 → 闸机 → 疏散完成
                          ↑
本层人员 ─────────────────┘
```

#### 核心约束
1. **扶梯方向固定**：所有扶梯只能 下层→本层，不能反向疏散
2. **步梯方向固定**：所有步梯只能 下层→本层，不能反向疏散
3. **闸机是唯一出口**：所有行人必须通过闸机疏散出场地
4. **持续涌入压力**：下层人员通过扶梯和步梯（共7个涌入点）持续涌入，无法阻止

### 4.3 疏散挑战

```
问题：涌入 vs 疏散 的压力平衡

时间轴：
t=0     本层: 1500人  |  下层待涌入: 1500人
        ─────────────────────────────────────
t=1min  本层: 1500 - X + Y 人
        X = 闸机疏散人数, Y = 扶梯涌入人数

        如果 X < Y → 本层人数增加 → 密度上升！
```

**核心目标**：确保 疏散速率 > 涌入速率

### 4.4 疏散出口能力估算

| 出口 | 位置 | 通行能力 |
|------|------|----------|
| 闸机a | 左侧 | ~100人/分钟 |
| 闸机子 | 右侧 | ~100人/分钟 |
| 闸机b/c/d | 上排×3 | ~450人/分钟 |
| 闸机e/f/g | 下排×3 | ~450人/分钟 |
| **总计** | 8组 | **~800人/分钟** |

**涌入速度**（扶梯×5 + 步梯×2）：~300 + ~80 = **~380人/分钟**

**净疏散速度**：800 - 380 = **~420人/分钟**

**大流量疏散时间**：3000人 ÷ 420人/分钟 ≈ **7分钟**（符合10分钟目标）

### 4.5 疏散流程

```
紧急模式触发
    ↓
1. 直升电梯停用
2. 扶梯保持向上（下层→本层），持续涌入（5个涌入点）
3. 步梯保持向上（下层→本层），持续涌入（2个涌入点）
4. 闸机完全开放（唯一疏散通道，8组）
    ↓
智能疏散引导系统启动（密度预测 + 动态分流）
    ↓
目标：在持续涌入压力下（7个涌入点），高效引导人群从闸机疏散
    ↓
核心策略：
- 预测未来5-10秒的区域密度分布
- 基于预测结果动态分配出口
- 优先疏散涌入点附近人员（减轻涌入压力）
- 负载均衡，避免闸机口形成瓶颈
```

---

## 五、模型泛化性设计要求 ⭐

> **这是本项目最重要的设计章节，所有实现都必须遵循以下要求。**

### 5.1 核心约束

```
┌─────────────────────────────────────────────────────────────────────┐
│                    模型泛化性要求                                     │
│                                                                     │
│   训练场景: 小流量 (1000人)                                          │
│       ↓                                                             │
│   应用场景: 小流量 (1000人) ✅                                        │
│             中流量 (2000人) ✅  必须能直接使用，无需重新训练            │
│             大流量 (3000人) ✅                                        │
│                                                                     │
│   ❌ 禁止: 为每种流量单独训练模型                                      │
│   ❌ 禁止: 模型依赖绝对人数                                           │
│   ❌ 禁止: 使用固定阈值                                               │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 归一化设计清单

#### 5.2.1 观测空间归一化

| 观测项 | 错误做法 ❌ | 正确做法 ✅ |
|--------|-----------|-----------|
| 出口密度 | `nearby_count / 25` | `nearby_count / (n_peds / n_exits)` |
| 剩余人数 | `remaining_count` | `remaining_count / n_peds` |
| 疏散人数 | `evacuated_count` | `evacuated_count / n_peds` |
| 瓶颈密度 | `gate_count / 20` | `gate_count / (n_peds * 0.25)` |

#### 5.2.2 奖励信号归一化

| 奖励项 | 错误做法 ❌ | 正确做法 ✅ |
|--------|-----------|-----------|
| 疏散奖励 | `+10 × 疏散人数` | `+10 × (疏散人数 / 总人数) × 100` |
| 拥堵惩罚 | `-2 × 拥堵人数` | `-2 × (拥堵人数 / 总人数)` |
| 均衡惩罚 | `-方差` | `-变异系数(CV)` |

#### 5.2.3 阈值动态化

| 阈值 | 错误做法 ❌ | 正确做法 ✅ |
|------|-----------|-----------|
| 出口过载 | `> 15人` | `> n_peds / n_exits × 1.5` |
| 危险密度 | `> 20人` | `> n_peds × 0.02` |
| 分流阈值 | `> 10人` | `> n_peds / n_exits × 1.2` |

### 5.3 观测空间设计（41维）

```python
observation_space = {
    # 出口相关 (10出口 × 3 = 30维)
    "exit_densities": 10,      # 各出口密度 (归一化到0-1)
    "exit_congestions": 10,    # 各出口拥堵度 (归一化到0-1)
    "exit_flow_rates": 10,     # 各出口流量 (归一化到0-1)

    # 全局状态 (6维)
    "remaining_ratio": 1,      # 剩余人数比例 (0-1)
    "time_ratio": 1,           # 时间比例 (0-1)
    "avg_speed_ratio": 1,      # 平均速度比例 (0-1)
    "panic_level": 1,          # 恐慌水平 (0-1)
    "crush_risk": 1,           # 踩踏风险 (0-1)
    "spawn_pressure": 1,       # 涌入压力 (0-1)

    # 瓶颈状态 (5维)
    "bottleneck_densities": 5, # 各瓶颈区密度 (0-1)
}
# 总计: 30 + 6 + 5 = 41 维
```

### 5.4 验证流程

```bash
# 1. 小流量训练
python examples/train_ppo_large_station.py \
    --flow-level small \
    --total-timesteps 500000

# 2. 跨规模验证（必须通过）
python examples/train_ppo_large_station.py \
    --scale-test outputs/models/ppo_large_station_small.zip

# 3. 验证输出示例
┌─────────────────────────────────────────────────────────┐
│ 跨规模泛化测试结果                                        │
├──────────┬────────────┬────────────┬───────────────────┤
│ 流量等级  │ 疏散率      │ 最大密度    │ 状态              │
├──────────┼────────────┼────────────┼───────────────────┤
│ small    │ 97.2%      │ 2.8 人/m²  │ ✅ PASS           │
│ medium   │ 93.5%      │ 3.4 人/m²  │ ✅ PASS           │
│ large    │ 88.1%      │ 4.2 人/m²  │ ✅ PASS           │
└──────────┴────────────┴────────────┴───────────────────┘
```

### 5.5 常见泛化失败原因

| 问题 | 症状 | 解决方案 |
|------|------|----------|
| 观测未归一化 | 大流量时观测值超出范围 | 检查 `_get_observation()` |
| 奖励未归一化 | 大流量时奖励过大/过小 | 检查 `_compute_reward()` |
| 固定阈值 | 大流量时策略失效 | 动态化所有阈值 |
| 硬编码人数 | 模型依赖特定人数 | 全部改为比例 |

---

## 六、SFM 改进方案 ⭐⭐

> **本章是研究的核心创新点：通过密度场预测和动态分流决策改进社会力模型，使疏散更快更稳。**

### 6.1 研究框架

```
┌─────────────────────────────────────────────────────────────────────┐
│                    SFM 改进框架                                      │
│                                                                     │
│   ┌─────────────┐                                                   │
│   │  原始 SFM   │  基线模型                                          │
│   └──────┬──────┘                                                   │
│          ↓                                                          │
│   ┌─────────────────────────────────────────┐                       │
│   │  SFM + 密度场预测                        │  改进1: 预测模块       │
│   │  · 预测未来 T 秒的区域密度分布            │                       │
│   │  · 提前感知拥堵，调整行人目标点           │                       │
│   └──────┬──────────────────────────────────┘                       │
│          ↓                                                          │
│   ┌─────────────────────────────────────────┐                       │
│   │  SFM + 动态分流决策                      │  改进2: 决策模块       │
│   │  · 基于密度预测智能分配出口              │                       │
│   │  · 规则引擎 + 密度感知路径规划           │                       │
│   └──────┬──────────────────────────────────┘                       │
│          ↓                                                          │
│   ┌─────────────────────────────────────────┐                       │
│   │  SFM + 预测 + 决策（完整方案）           │  最终模型              │
│   └─────────────────────────────────────────┘                       │
│                                                                     │
│   对比实验:                                                          │
│   ① 原始 SFM（基线）                                                 │
│   ② SFM + 密度预测                                                   │
│   ③ SFM + 动态分流                                                   │
│   ④ SFM + 预测 + 分流（完整方案）                                     │
│   ⑤ SFM + PPO引导（对比：证明RL方法的缺点）                           │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 为什么不用个体轨迹预测？

| 问题 | 个体轨迹预测 (Social-LSTM等) | 密度场预测 |
|------|---------------------------|-----------|
| **计算量** | O(n²) 邻居计算，3000人太慢 | O(grid)，与人数无关 |
| **泛化性** | 1000人→3000人，邻居数变化大 | 网格结构固定，天然泛化 |
| **实际价值** | 拥挤时人被推着走，个体轨迹意义不大 | 直接预测拥堵区域，更实用 |
| **物理意义** | 数据驱动，黑盒 | 与SFM物理模型一致 |

### 6.3 密度场预测模块

#### 6.3.1 设计思路

```
┌─────────────────────────────────────────────────────────────────────┐
│  密度场预测：预测区域密度，而非个体轨迹                                │
│                                                                     │
│  场景: 150m × 80m (T形结构)                                         │
│  网格: 30 × 16 格子（每格 5m × 5m）                                  │
│                                                                     │
│  输入: 当前密度网格 D(t)     [30×16]                                 │
│        当前流场网格 V(t)     [30×16×2] (vx, vy)                      │
│        出口位置编码          [30×16] (距离场)                        │
│                                                                     │
│  输出: 未来密度网格 D(t+Δt)  [30×16]                                 │
│        预测时间窗口: Δt = 5-10 秒                                    │
└─────────────────────────────────────────────────────────────────────┘
```

#### 6.3.2 模型选择

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **ConvLSTM** | 捕捉时空关系，效果好 | 训练较慢 | ⭐⭐⭐ |
| **简单CNN** | 快速，易实现 | 时序建模弱 | ⭐⭐ |
| **物理模型** | 无需训练，可解释 | 精度有限 | ⭐⭐ |
| **U-Net** | 高精度 | 过于复杂 | ⭐ |

**推荐方案: ConvLSTM**

```python
# 模型结构示意
class DensityPredictor(nn.Module):
    def __init__(self):
        self.encoder = nn.Sequential(
            nn.Conv2d(4, 32, 3, padding=1),  # 输入: density + vx + vy + exit_dist
            nn.ReLU(),
            nn.Conv2d(32, 64, 3, padding=1),
        )
        self.convlstm = ConvLSTM(64, 64, kernel_size=3)
        self.decoder = nn.Sequential(
            nn.Conv2d(64, 32, 3, padding=1),
            nn.ReLU(),
            nn.Conv2d(32, 1, 3, padding=1),  # 输出: 预测密度
            nn.Sigmoid(),  # 归一化到 [0, 1]
        )
```

#### 6.3.3 泛化性保证

| 设计要点 | 说明 |
|----------|------|
| **网格固定** | 30×12 网格，不随人数变化 |
| **密度归一化** | 密度值归一化到 [0, 1]，基于最大安全密度 |
| **相对特征** | 使用密度比例，而非绝对人数 |

```python
# 密度归一化
MAX_SAFE_DENSITY = 4.0  # 人/m²
normalized_density = min(local_density / MAX_SAFE_DENSITY, 1.0)
```

### 6.4 动态分流决策模块

#### 6.4.1 设计思路

```
┌─────────────────────────────────────────────────────────────────────┐
│  动态分流：基于密度预测，智能分配出口                                  │
│                                                                     │
│  输入:                                                               │
│  · 当前密度场 D(t)                                                   │
│  · 预测密度场 D(t+Δt)                                                │
│  · 各出口当前负载                                                    │
│  · 行人当前位置                                                      │
│                                                                     │
│  输出:                                                               │
│  · 每个行人的推荐出口                                                 │
│  · 中间路径点（waypoints）                                           │
└─────────────────────────────────────────────────────────────────────┘
```

#### 6.4.2 分流规则引擎

```python
class DynamicRouter:
    def assign_exit(self, pedestrian, density_current, density_predicted):
        """为行人分配最优出口"""

        scores = {}
        for exit in self.exits:
            # 1. 距离分数（越近越好）
            dist_score = 1.0 / (distance(pedestrian.pos, exit.pos) + 1)

            # 2. 当前拥堵分数（越空越好）
            current_congestion = density_current[exit.grid_pos]
            congestion_score = 1.0 - current_congestion

            # 3. 预测拥堵分数（预测越空越好）⭐ 关键创新
            predicted_congestion = density_predicted[exit.grid_pos]
            predicted_score = 1.0 - predicted_congestion

            # 4. 负载均衡分数
            load_ratio = exit.current_load / exit.capacity
            balance_score = 1.0 - load_ratio

            # 综合评分
            scores[exit] = (
                0.3 * dist_score +
                0.2 * congestion_score +
                0.3 * predicted_score +    # 预测权重高
                0.2 * balance_score
            )

        return max(scores, key=scores.get)
```

#### 6.4.3 特殊规则

| 规则 | 条件 | 动作 |
|------|------|------|
| **扶梯口优先** | 行人在扶梯口 5m 内 | 优先疏散，减轻涌入压力 |
| **拥堵回避** | 预测密度 > 3.0 人/m² | 分流到其他出口 |
| **紧急分流** | 当前密度 > 3.5 人/m² | 立即切换出口 |
| **负载均衡** | 出口负载差 > 30% | 重新分配 |

### 6.5 与 SFM 的集成

```python
class EnhancedSFM:
    """改进的社会力模型"""

    def __init__(self):
        self.sfm = SocialForceModel()           # 原始 SFM
        self.predictor = DensityPredictor()     # 密度预测模块
        self.router = DynamicRouter()           # 动态分流模块

    def step(self, dt):
        # 1. 计算当前密度场
        density_current = self.compute_density_field()

        # 2. 预测未来密度场（每 N 步更新一次）
        if self.step_count % self.predict_interval == 0:
            self.density_predicted = self.predictor.predict(
                density_current,
                self.flow_field,
                horizon=5.0  # 预测 5 秒后
            )

        # 3. 动态分配出口
        for ped in self.pedestrians:
            if self.should_reassign(ped):
                ped.target_exit = self.router.assign_exit(
                    ped,
                    density_current,
                    self.density_predicted
                )

        # 4. 原始 SFM 力计算和位置更新
        self.sfm.step(dt)
```

### 6.6 预期效果

| 指标 | 原始 SFM | SFM + 预测 + 分流 | 提升 |
|------|----------|------------------|------|
| 疏散时间 | ~11.5 分钟 | < 10 分钟 | 15%+ |
| 最大密度 | > 4.5 人/m² | < 4.0 人/m² | 安全 |
| 出口均衡度 | 差异 > 40% | 差异 < 20% | 均衡 |
| 拥堵次数 | 多次 | 显著减少 | 稳定 |

### 6.7 PPO 对比实验

> PPO 引导作为对比实验，证明其缺点：

| 对比项 | PPO 引导 | 密度预测 + 分流 |
|--------|----------|----------------|
| 训练时间 | 数小时 | 较短 |
| 泛化性 | 需验证 | 天然泛化 |
| 可解释性 | 黑盒 | 规则清晰 |
| 实时性 | 推理快 | 更快（无需网络） |
| 计算资源 | 需要 GPU 训练 | CPU 即可 |

---

## 七、技术实现计划

### 7.1 代码结构

```
src/
├── simulation/
│   ├── metro_evacuation_env.py      # 当前环境（保留）
│   └── large_station_env.py         # 新场景环境 ⭐
├── sfm/
│   ├── social_force.py              # 社会力模型
│   └── pedestrian_types.py          # 行人类型定义 ⭐ (新增/扩展)
├── configs/
│   └── large_station_config.yaml    # 新场景配置 ⭐
└── examples/
    ├── train_ppo_large_station.py   # 新场景训练 ⭐
    └── pygame_large_station.py      # 新场景可视化 ⭐
```

### 7.2 开发阶段

#### 阶段1：基础环境搭建 ✅ 已完成
- [x] 创建新场景环境类 `LargeStationEnv`
- [x] 定义场景尺寸和边界 (150m × 80m T形结构)
- [x] 添加固定障碍物（墙、扶梯护栏）
- [x] 实现基本的行人生成和移动

#### 阶段2：行人类型扩展 ✅ 已完成
- [x] 添加带行李行人类型 (`WITH_SMALL_BAG`, `WITH_LUGGAGE`, `WITH_LARGE_LUGGAGE`)
- [x] 实现不同行人的速度和半径参数
- [x] 更新 `social_force.py` 和 `social_force_gpu.py`

#### 阶段3：设施和出口 ✅ 已完成
- [x] 实现涌入点 (7个：5扶梯 + 2步梯，只进不出)
- [x] 实现闸机疏散口 (8组：a、子、b/c/d、e/f/g)
- [x] 实现直升电梯（及禁用逻辑）

#### 阶段4：紧急模式 ✅ 已完成
- [x] 实现模式切换逻辑 (`emergency_mode` 参数)
- [x] 实现扶梯持续涌入 (`_spawn_from_escalator`)
- [x] 实现出口方向控制

#### 阶段5：归一化和大规模支持 ✅ 已完成
- [x] 应用归一化改造（参考迁移指南）
- [x] 添加大规模安全机制 (`_detect_crush_risk`, `_spread_panic`)
- [x] 观测空间归一化 (41维)

#### 阶段6：PPO训练和消融实验
- [ ] 训练PPO引导模型 (脚本已创建: `train_ppo_large_station.py`)
- [ ] 运行消融实验
- [ ] 验证泛化性 (`scale_test` 函数)

---

## 八、待确认问题汇总

### 已确认 ✅

- [x] **总人流量**：小(1000)、中(2000)、大(3000)
- [x] **人流来源**：上层(本层) + 下层(扶梯涌入)
- [x] **场景尺寸**：150m × 80m（T形结构）
- [x] **扶梯方向**：只能下层→本层，只进不出（5个扶梯涌入点）
- [x] **步梯方向**：只能下层→本层，只进不出（2个步梯涌入点）
- [x] **涌入点总数**：7个（5扶梯 + 2步梯）
- [x] **疏散出口**：仅闸机（8组），无其他疏散出口
- [x] **电梯状态**：紧急情况下禁用
- [x] **行李比例**：小包25%、拉杆箱12%、大行李3%
- [x] **立柱**：暂时不添加
- [x] **疏散时间目标**：10分钟内

### 已确认参数

1. **步梯方向**：紧急情况下步梯**只进不出**
   - 步梯是下层人员涌入点（2个）
   - 与扶梯一样，下层人员从步梯持续涌入本层

2. **疏散出口**：仅为8组闸机
   - 闸机a（左侧）、闸机子（右侧）：各~100人/分钟
   - 闸机b/c/d（上排）、闸机e/f/g（下排）：各~150人/分钟

3. **各闸机组通道数**：每组闸机**5个通道**
   - 单通道通行能力：~20-30人/分钟
   - 总疏散能力：~800人/分钟

---

## 九、详细场景布局（坐标系）

```
场景尺寸: 150m × 80m (T形结构)
坐标原点: 左下角 (0, 0)
X轴: 向右为正 (0-150m)
Y轴: 向上为正 (0-80m)

                           Y=80
    ┌─────────────────┐
    │ 步梯  扶梯       │ (左上角区域 X:0-20, Y:65-80)
    │ (2,65) (10,65)  ├────────────────────────────────────────────┐
    │                 │      闸机b        闸机c        闸机d        │ Y=70
    │ 闸机a           │     (45,67)     (75,67)     (105,67)       │
Y=40│ (0,30)          │                                     闸机子 │ Y=40
    │                 │     ┌────┐      ┌────┐      ┌────┐ (147,30)│
    │                 │     │扶梯1│      │扶梯2│      │扶梯3│        │
    │ 直升电梯(禁用)   │     │(40) │      │(70) │      │(100)│        │
    │ (20,26)         │     └────┘      └────┘      └────┘        │
    │                 │      闸机e        闸机f        闸机g        │ Y=10
    │ 步梯  扶梯       ├────(45,10)────(75,10)────(105,10)─────────┘
    │ (2,3) (10,3)    │ (左下角区域 X:0-20, Y:0-15)
    └─────────────────┘
                           Y=0                                   X=150
```

### 设施精确坐标

| 设施 | 位置 (X, Y) | 尺寸 | 说明 |
|------|-------------|------|------|
| **步梯-左上** | (2, 65) | 6m×12m | 涌入点（只进不出） |
| **扶梯-左上** | (10, 65) | 6m×12m | 涌入点（只进不出） |
| **步梯-左下** | (2, 3) | 6m×12m | 涌入点（只进不出） |
| **扶梯-左下** | (10, 3) | 6m×12m | 涌入点（只进不出） |
| **直升电梯** | (20, 26) | 8m×8m | 禁用 |
| **闸机a** | (0, 30) | 3m×20m | 疏散口（左侧） |
| **闸机子** | (147, 30) | 3m×20m | 疏散口（右侧） |
| **闸机b** | (45, 67) | 15m×3m | 疏散口（上排） |
| **闸机c** | (75, 67) | 15m×3m | 疏散口（上排） |
| **闸机d** | (105, 67) | 15m×3m | 疏散口（上排） |
| **闸机e** | (45, 10) | 15m×3m | 疏散口（下排） |
| **闸机f** | (75, 10) | 15m×3m | 疏散口（下排） |
| **闸机g** | (105, 10) | 15m×3m | 疏散口（下排） |
| **扶梯1** | (40, 32) | 25m×16m | 中间涌入点 |
| **扶梯2** | (70, 32) | 25m×16m | 中间涌入点 |
| **扶梯3** | (100, 32) | 25m×16m | 中间涌入点 |

**涌入点总数**: 7个
- 扶梯: 5个（左上1 + 左下1 + 中间3）
- 步梯: 2个（左上1 + 左下1）

### 疏散通道说明

> ⚠️ 本场景中**闸机是唯一疏散出口**，不存在"绿色出入口"概念。
>
> 所有行人必须通过8组闸机疏散离开场地。

---

## 十、实现进度

### 已完成 ✅

1. ~~确认待确认问题~~（已使用默认假设）
2. ✅ 绘制详细场景布局图
3. ✅ 扩展行人类型 (`src/sfm/social_force.py`)
   - `WITH_SMALL_BAG`: 速度1.2m/s, 半径0.35m
   - `WITH_LUGGAGE`: 速度0.9m/s, 半径0.5m
   - `WITH_LARGE_LUGGAGE`: 速度0.7m/s, 半径0.6m
4. ✅ 创建场景配置 (`configs/large_station_config.yaml`)
5. ✅ 创建环境类 (`src/simulation/large_station_env.py`)
   - 150m × 80m T形场景
   - 8组闸机疏散口, 7个涌入点(5扶梯+2步梯)
   - 41维归一化观测空间
   - 紧急模式 (扶梯和步梯持续涌入)
   - 大规模安全机制
6. ✅ 创建训练脚本 (`examples/train_ppo_large_station.py`)
   - 支持 small/medium/large 三种流量
   - 跨规模泛化测试 (`scale_test`)

### 下一步行动

1. **运行训练**:
   ```bash
   # 小流量快速训练 (推荐先测试)
   python examples/train_ppo_large_station.py --flow-level small --total-timesteps 200000

   # 中流量验证
   python examples/train_ppo_large_station.py --flow-level medium --total-timesteps 100000

   # 跨规模测试
   python examples/train_ppo_large_station.py --scale-test outputs/models/ppo_large_station_small.zip
   ```

2. **验证环境**:
   ```python
   from simulation.large_station_env import LargeStationEnv
   env = LargeStationEnv(flow_level="small")
   obs, _ = env.reset()
   print(f"观测维度: {obs.shape}")  # 期望: (41,)
   ```

3. **消融实验**: 待PPO训练完成后运行

---

---

## 变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v0.1 | 2024-01-20 | 初始版本 |
| v0.2 | 2024-01-23 | 添加设施坐标、归一化改造 |
| v0.3 | 2025-01-23 | 添加核心设计原则、模型泛化性要求、完善行李设计 |
| v0.4 | 2025-01-23 | 添加SFM改进方案：密度场预测 + 动态分流决策 |
| v0.5 | 2025-01-23 | **重大修正**：场景尺寸150×80m(T形)、闸机为唯一疏散口、7个涌入点(5扶梯+2步梯)、移除恐慌行为、移除不存在设施 |

---

*文档版本: v0.5*
*更新日期: 2025-01-23*
*状态: 开发中*

**核心创新**: SFM + 密度场预测 + 动态分流 → 更快更稳的疏散

**场景核心约束**:
- 场景: 150m × 80m (T形结构)
- 疏散出口: 仅8组闸机 (~800人/分钟)
- 涌入点: 7个（5扶梯 + 2步梯，~380人/分钟）
- 禁用设施: 1个直升电梯
