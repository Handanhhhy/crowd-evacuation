# 新地铁站场景开发计划

## 场景概述

### 基本参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 场景尺寸 | 150m × 60m | 东西向 × 南北向 |
| 层高 | 4.5-5.0m | 站厅层 |
| 面积 | 9000 m² | 约为当前场景的3.75倍 |

### 设施清单

| 设施类型 | 编号/位置 | 数量 | 紧急模式 |
|----------|----------|------|----------|
| 步梯 | 左上、左下 | 2个 | 可用(只出) |
| 扶梯 | 左上（与步梯并列） | 1组 | 可用(只出) |
| 直升电梯 | 左侧中间 | 1个 | **禁用** |
| 闸机a | 左侧(垂直) | 1组 | 只出不进 |
| 闸机子 | 右侧(垂直) | 1组 | 只出不进 |
| 闸机b/c/d | 上排(水平) | 3组 | 只出不进 |
| 闸机e/f/g | 下排(水平) | 3组 | 只出不进 |
| 自动扶梯 | 中间区域 | 3组 | 可用(双向改单向出) |
| 绿色出入口 | 四周 | 多个 | **只进不出** |

---

## 一、行人类型扩展

### 1.1 当前行人类型

```python
PedestrianType:
  - NORMAL     # 普通成人
  - ELDERLY    # 老人
  - CHILD      # 儿童
  - IMPATIENT  # 急躁型
```

### 1.2 新增：带行李行人

| 类型 | 速度 | 半径 | 特点 |
|------|------|------|------|
| `WITH_SMALL_BAG` | 1.2 m/s | 0.35m | 背包/手提包 |
| `WITH_LUGGAGE` | 0.9 m/s | 0.5m | 拉杆箱 |
| `WITH_LARGE_LUGGAGE` | 0.7 m/s | 0.6m | 大行李 |

### 1.3 行人类型分布（待确认）

**日常模式**：
```yaml
pedestrian_distribution:
  NORMAL: 0.40          # 40% 普通
  ELDERLY: 0.10         # 10% 老人
  CHILD: 0.05           # 5% 儿童
  IMPATIENT: 0.05       # 5% 急躁
  WITH_SMALL_BAG: 0.25  # 25% 小包
  WITH_LUGGAGE: 0.12    # 12% 拉杆箱
  WITH_LARGE_LUGGAGE: 0.03  # 3% 大行李
```

**高峰模式**（通勤为主）：
```yaml
pedestrian_distribution:
  NORMAL: 0.50
  IMPATIENT: 0.15
  WITH_SMALL_BAG: 0.30
  WITH_LUGGAGE: 0.05
```

---

## 二、人流量设置

### 2.1 双层人流模型

人流分为**上层（本层已有）**和**下层（从扶梯涌入）**两部分：

```
                    ┌──────────────────────────┐
                    │      上层人流            │
                    │   (本层已有，等待出站)    │
                    └──────────────────────────┘
                              ↑
                    ┌──────────────────────────┐
                    │      下层人流            │
                    │  (从扶梯持续涌入)        │
                    └──────────────────────────┘
```

### 2.2 人流量等级定义 ✅

| 等级 | 上层人数 | 下层人数 | **总人数** | 密度 |
|------|---------|---------|-----------|------|
| **小** | 500人 | 500人 | **1000人** | 0.11人/m² |
| **中** | 1000人 | 1000人 | **2000人** | 0.22人/m² |
| **大** | 1500人 | 1500人 | **3000人** | 0.33人/m² |

### 2.3 人流生成逻辑

#### 上层人流（初始生成）
- **生成时机**：仿真开始时一次性生成
- **生成位置**：
  - 闸机区域内（等待过闸）
  - 中间通道（行走中）
  - 扶梯附近（刚到达）

#### 下层人流（持续涌入）
- **生成时机**：仿真过程中持续从扶梯口生成
- **生成位置**：3个扶梯出口
- **生成速率**：根据扶梯通行能力（约60人/分钟/扶梯）

```python
# 人流生成配置示例
FLOW_CONFIG = {
    "small": {
        "upper_layer": 500,      # 上层初始人数
        "lower_layer": 500,      # 下层总涌入人数
        "spawn_rate": 3.0,       # 每秒从扶梯涌入人数
    },
    "medium": {
        "upper_layer": 1000,
        "lower_layer": 1000,
        "spawn_rate": 5.0,
    },
    "large": {
        "upper_layer": 1500,
        "lower_layer": 1500,
        "spawn_rate": 8.0,
    },
}
```

### 2.4 人流生成区域

```
紧急疏散场景示意图：
┌─────────────────────────────────────────────────────────────────┐
│ [步梯↑]  [扶梯↑]                                                 │
│                    [闸机b]    [闸机c]    [闸机d]                  │
│                        ↓          ↓          ↓                   │
│ [闸机a]                                                [闸机子]   │
│    ↓      ═══════════════════════════════════════════     ↓      │
│          [扶梯1 ↑↓]   [扶梯2 ↑↓]   [扶梯3 ↑↓]                    │
│ [直梯×]   ═══════════════════════════════════════════            │
│                ↑          ↑          ↑                           │
│ [步梯↑]   [闸机e]    [闸机f]    [闸机g]                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

图例：
↑ = 疏散方向（出口）
↓ = 人流涌入方向
× = 紧急模式禁用
═ = 中间扶梯区域（下层人流涌入点）
```

### 2.5 疏散出口（紧急模式）

| 出口 | 位置 | 通行能力 | 状态 |
|------|------|----------|------|
| 步梯-左上 | 左上角 | ~40人/分钟 | ✅ 可用 |
| 步梯-左下 | 左下角 | ~40人/分钟 | ✅ 可用 |
| 扶梯-左上 | 左上（与步梯并列） | ~60人/分钟 | ✅ 可用 |
| 扶梯-中1/2/3 | 中间区域 | ~60人/分钟×3 | ⚠️ 逆向疏散 |
| 直升电梯 | 左侧中间 | - | ❌ 禁用 |

**总疏散能力**：约 40×2 + 60×4 = **320人/分钟**

### 2.6 关键挑战

| 人流等级 | 总人数 | 理论疏散时间 | 挑战 |
|----------|--------|-------------|------|
| 小 | 1000人 | ~3分钟 | 低 |
| 中 | 2000人 | ~6分钟 | 中（扶梯对冲） |
| 大 | 3000人 | ~9分钟 | 高（严重拥堵风险） |

**核心难点**：中间扶梯区域存在**人流对冲**
- 上层人员想要通过扶梯**向下**疏散
- 下层人员正在通过扶梯**向上**涌入
- 紧急模式下需要切换扶梯方向

---

## 三、障碍物分布

### 3.1 固定障碍物

| 类型 | 位置 | 尺寸 | 说明 |
|------|------|------|------|
| 闸机隔板 | 各闸机组之间 | 0.5m宽 | 不可穿越 |
| 扶梯护栏 | 扶梯两侧 | 1m高 | 边界 |
| 立柱 | 待标注 | 0.8m直径 | 承重柱 |
| 服务台 | 待标注 | 2m×3m | 固定设施 |
| 自动售票机 | 待标注 | 1m×0.6m | 排列 |

### 3.2 可变障碍物（不同配置）

**配置A - 标准**：
```yaml
obstacles:
  ticket_machines: 6    # 自动售票机
  service_desks: 1      # 服务台
  trash_bins: 4         # 垃圾桶
  ad_pillars: 2         # 广告柱
```

**配置B - 拥挤**：
```yaml
obstacles:
  ticket_machines: 10
  service_desks: 2
  trash_bins: 6
  ad_pillars: 4
  temporary_barriers: 2  # 临时围栏
```

**配置C - 紧急疏散优化**：
```yaml
obstacles:
  ticket_machines: 6
  service_desks: 0       # 移除
  trash_bins: 2
  ad_pillars: 0          # 移除
  guide_barriers: 4      # 引导围栏（帮助分流）
```

### 3.3 待确认问题

- [ ] 立柱的具体位置和数量？
- [ ] 自动售票机的位置？
- [ ] 服务台位置？
- [ ] 其他固定设施？

---

## 四、紧急模式逻辑 ✅

### 4.1 核心约束

```
┌────────────────────────────────────────────────────────────────┐
│                        本层 (站厅层)                            │
│                                                                │
│   ┌─────┐                                        ┌─────┐       │
│   │绿色 │  ←────── 疏散方向 ──────→              │绿色 │       │
│   │出口 │         (只进不出)                     │出口 │       │
│   └─────┘                                        └─────┘       │
│                                                                │
│            [扶梯1↑]   [扶梯2↑]   [扶梯3↑]                       │
│               ↑          ↑          ↑                          │
│               │          │          │                          │
│          下层人员持续涌入（不可阻止）                            │
│                                                                │
└────────────────────────────────────────────────────────────────┘

关键约束：
1. 扶梯只能 下层→本层（不能反向疏散）
2. 电梯紧急情况下禁用
3. 绿色出入口是唯一疏散通道
```

### 4.2 设施状态（紧急模式）

| 设施 | 状态 | 说明 |
|------|------|------|
| **绿色出入口** | 只进不出 | **唯一疏散出口**（人员进入出口离开本层） |
| **闸机** | 只出不进 | 辅助疏散通道（从闸机区出去） |
| **直升电梯** | **禁用** | 紧急情况下不可使用 |
| **中间扶梯×3** | 只上不下 | **持续涌入点**（下层人员涌入，不可阻止） |
| **左上扶梯** | 只上不下 | 同上 |
| **步梯×2** | 可双向？ | 待确认：是否可以向下疏散？ |

### 4.3 疏散挑战

```
问题：疏散 vs 涌入 的矛盾

时间轴：
t=0     本层: 1500人  |  下层待涌入: 1500人
        ─────────────────────────────────────
t=1min  本层: 1500-X+Y人
        X = 疏散人数, Y = 涌入人数

        如果 Y > X → 本层人数增加 → 拥堵加剧！
```

**核心难点**：
- 下层人员持续涌入，无法阻止
- 疏散速度必须 > 涌入速度，否则会越来越拥挤
- PPO需要学会在涌入压力下高效疏散

### 4.4 疏散出口能力估算

| 出口 | 位置 | 通行能力 |
|------|------|----------|
| 绿色出口-左 | 左侧 | ~100人/分钟 |
| 绿色出口-右 | 右侧 | ~100人/分钟 |
| 绿色出口-上排 | 闸机b/c/d后 | ~150人/分钟 |
| 绿色出口-下排 | 闸机e/f/g后 | ~150人/分钟 |
| **总计** | - | **~500人/分钟** |

**涌入速度**（扶梯×4）：~240人/分钟

**净疏散速度**：500 - 240 = **~260人/分钟**

**大流量疏散时间**：3000人 ÷ 260人/分钟 ≈ **11.5分钟**

⚠️ 略超10分钟目标，需要PPO优化引导策略

### 4.5 疏散流程

```
紧急模式触发
    ↓
1. 直升电梯停用
2. 绿色出入口切换为疏散模式（只进不出）
3. 闸机切换为只出不进
4. 扶梯保持向上（下层→本层），无法改变
    ↓
PPO引导系统启动
    ↓
目标：在持续涌入压力下，高效引导人群疏散
    ↓
优化策略：
- 分流到不同绿色出口
- 避免瓶颈拥堵
- 优先疏散扶梯出口附近人员（减轻涌入压力）
```

---

## 五、技术实现计划

### 5.1 代码结构

```
src/
├── simulation/
│   ├── metro_evacuation_env.py      # 当前环境（保留）
│   └── large_station_env.py         # 新场景环境 ⭐
├── sfm/
│   ├── social_force.py              # 社会力模型
│   └── pedestrian_types.py          # 行人类型定义 ⭐ (新增/扩展)
├── configs/
│   └── large_station_config.yaml    # 新场景配置 ⭐
└── examples/
    ├── train_ppo_large_station.py   # 新场景训练 ⭐
    └── pygame_large_station.py      # 新场景可视化 ⭐
```

### 5.2 开发阶段

#### 阶段1：基础环境搭建 ✅ 已完成
- [x] 创建新场景环境类 `LargeStationEnv`
- [x] 定义场景尺寸和边界 (150m × 60m)
- [x] 添加固定障碍物（墙、闸机隔板、扶梯护栏）
- [x] 实现基本的行人生成和移动

#### 阶段2：行人类型扩展 ✅ 已完成
- [x] 添加带行李行人类型 (`WITH_SMALL_BAG`, `WITH_LUGGAGE`, `WITH_LARGE_LUGGAGE`)
- [x] 实现不同行人的速度和半径参数
- [x] 更新 `social_force.py` 和 `social_force_gpu.py`

#### 阶段3：设施和出口 ✅ 已完成
- [x] 实现步梯/扶梯出口 (10个出口)
- [x] 实现闸机通道 (8组闸机)
- [x] 实现绿色出入口
- [x] 实现直升电梯（及禁用逻辑）

#### 阶段4：紧急模式 ✅ 已完成
- [x] 实现模式切换逻辑 (`emergency_mode` 参数)
- [x] 实现扶梯持续涌入 (`_spawn_from_escalator`)
- [x] 实现出口方向控制

#### 阶段5：归一化和大规模支持 ✅ 已完成
- [x] 应用归一化改造（参考迁移指南）
- [x] 添加大规模安全机制 (`_detect_crush_risk`, `_spread_panic`)
- [x] 观测空间归一化 (41维)

#### 阶段6：PPO训练和消融实验
- [ ] 训练PPO引导模型 (脚本已创建: `train_ppo_large_station.py`)
- [ ] 运行消融实验
- [ ] 验证泛化性 (`scale_test` 函数)

---

## 六、待确认问题汇总

### 已确认 ✅

- [x] **总人流量**：小(1000)、中(2000)、大(3000)
- [x] **人流来源**：上层(本层) + 下层(扶梯涌入)
- [x] **场景尺寸**：150m × 60m
- [x] **扶梯方向**：只能下层→本层，不能反向疏散
- [x] **电梯状态**：紧急情况下禁用
- [x] **行李比例**：小包25%、拉杆箱12%、大行李3%
- [x] **立柱**：暂时不添加
- [x] **疏散时间目标**：10分钟内

### 假设参数（默认值，可调整）

1. **步梯方向**：假设紧急情况下步梯**可以向下**疏散到下层
   - 步梯作为额外的疏散出口
   - 容量：~40人/分钟/个

2. **绿色出口位置**（基于150m×60m场景）：
   ```
   坐标系：左下角为原点(0,0)，向右为X+，向上为Y+

   绿色出口-左上: (0, 55)     宽度: 8m
   绿色出口-左下: (0, 5)      宽度: 8m
   绿色出口-右上: (150, 55)   宽度: 8m
   绿色出口-右下: (150, 5)    宽度: 8m
   绿色出口-上1:  (40, 60)    宽度: 10m (闸机b后)
   绿色出口-上2:  (75, 60)    宽度: 10m (闸机c后)
   绿色出口-上3:  (110, 60)   宽度: 10m (闸机d后)
   绿色出口-下1:  (40, 0)     宽度: 10m (闸机e后)
   绿色出口-下2:  (75, 0)     宽度: 10m (闸机f后)
   绿色出口-下3:  (110, 0)    宽度: 10m (闸机g后)
   ```

3. **各闸机组通道数**：假设每组闸机**5个通道**
   - 单通道通行能力：~20人/分钟
   - 单组通行能力：~100人/分钟

---

## 七、详细场景布局（坐标系）

```
场景尺寸: 150m × 60m
坐标原点: 左下角 (0, 0)
X轴: 向右为正 (0-150m)
Y轴: 向上为正 (0-60m)

                    Y=60
    ┌─────────────────────────────────────────────────────────────────┐
    │ [出口-左上]  [步梯] [扶梯]           [出口-上1] [出口-上2] [出口-上3] │
    │ x:0,y:51-59  x:10  x:18           x:35-45   x:70-80   x:105-115  │
    │                                                                  │
    │              ┌──────┐ ┌──────┐ ┌──────┐                          │
    │              │闸机b │ │闸机c │ │闸机d │                          │
    │              │x:35  │ │x:70  │ │x:105 │                          │
    │              │y:45  │ │y:45  │ │y:45  │                          │
    │              └──────┘ └──────┘ └──────┘                          │
    │                                                                  │
    │ ┌───┐                                                    ┌───┐   │
    │ │闸a│                                                    │闸子│  │
    │ │x:5│     ════════════════════════════════════════════   │x:145  │
Y=30│ │y:30     [扶梯1]      [扶梯2]      [扶梯3]                │y:30│  │
    │ └───┘      x:50         x:75        x:100                └───┘   │
    │           ════════════════════════════════════════════           │
    │ [直梯×]                                                          │
    │  x:8,y:25                                                        │
    │              ┌──────┐ ┌──────┐ ┌──────┐                          │
    │              │闸机e │ │闸机f │ │闸机g │                          │
    │ [步梯]       │x:35  │ │x:70  │ │x:105 │                          │
    │ x:10,y:5     │y:15  │ │y:15  │ │y:15  │                          │
    │              └──────┘ └──────┘ └──────┘                          │
    │                                                                  │
    │ [出口-左下]              [出口-下1] [出口-下2] [出口-下3]          │
    │ x:0,y:1-9               x:35-45   x:70-80   x:105-115           │
    └─────────────────────────────────────────────────────────────────┘
                    Y=0                                        X=150
```

### 设施精确坐标

| 设施 | 位置 (x, y) | 尺寸 | 方向 |
|------|-------------|------|------|
| **扶梯-左上** | (18, 55) | 4m×2m | 向上 |
| **步梯-左上** | (10, 55) | 3m×2m | 双向 |
| **步梯-左下** | (10, 5) | 3m×2m | 双向 |
| **直梯** | (8, 25) | 2m×2m | 禁用 |
| **扶梯1** | (50, 30) | 4m×8m | 向上 |
| **扶梯2** | (75, 30) | 4m×8m | 向上 |
| **扶梯3** | (100, 30) | 4m×8m | 向上 |
| **闸机a** | (5, 25-35) | 2m×10m | 垂直 |
| **闸机子** | (145, 25-35) | 2m×10m | 垂直 |
| **闸机b** | (35, 45) | 10m×3m | 水平 |
| **闸机c** | (70, 45) | 10m×3m | 水平 |
| **闸机d** | (105, 45) | 10m×3m | 水平 |
| **闸机e** | (35, 15) | 10m×3m | 水平 |
| **闸机f** | (70, 15) | 10m×3m | 水平 |
| **闸机g** | (105, 15) | 10m×3m | 水平 |

### 出口精确坐标

| 出口ID | 位置 (x, y) | 宽度 | 方向 |
|--------|-------------|------|------|
| exit_left_upper | (0, 55) | 8m | 向左 |
| exit_left_lower | (0, 5) | 8m | 向左 |
| exit_upper_1 | (40, 60) | 10m | 向上 |
| exit_upper_2 | (75, 60) | 10m | 向上 |
| exit_upper_3 | (110, 60) | 10m | 向上 |
| exit_lower_1 | (40, 0) | 10m | 向下 |
| exit_lower_2 | (75, 0) | 10m | 向下 |
| exit_lower_3 | (110, 0) | 10m | 向下 |
| stair_upper | (10, 55) | 3m | 向上 |
| stair_lower | (10, 5) | 3m | 向下 |

---

## 八、实现进度

### 已完成 ✅

1. ~~确认待确认问题~~（已使用默认假设）
2. ✅ 绘制详细场景布局图
3. ✅ 扩展行人类型 (`src/sfm/social_force.py`)
   - `WITH_SMALL_BAG`: 速度1.2m/s, 半径0.35m
   - `WITH_LUGGAGE`: 速度0.9m/s, 半径0.5m
   - `WITH_LARGE_LUGGAGE`: 速度0.7m/s, 半径0.6m
4. ✅ 创建场景配置 (`configs/large_station_config.yaml`)
5. ✅ 创建环境类 (`src/simulation/large_station_env.py`)
   - 150m × 60m 场景
   - 10个出口, 4个扶梯涌入点
   - 41维归一化观测空间
   - 紧急模式 (扶梯持续涌入)
   - 大规模安全机制
6. ✅ 创建训练脚本 (`examples/train_ppo_large_station.py`)
   - 支持 small/medium/large 三种流量
   - 跨规模泛化测试 (`scale_test`)

### 下一步行动

1. **运行训练**:
   ```bash
   # 小流量快速训练 (推荐先测试)
   python examples/train_ppo_large_station.py --flow-level small --total-timesteps 200000

   # 中流量验证
   python examples/train_ppo_large_station.py --flow-level medium --total-timesteps 100000

   # 跨规模测试
   python examples/train_ppo_large_station.py --scale-test outputs/models/ppo_large_station_small.zip
   ```

2. **验证环境**:
   ```python
   from simulation.large_station_env import LargeStationEnv
   env = LargeStationEnv(flow_level="small")
   obs, _ = env.reset()
   print(f"观测维度: {obs.shape}")  # 期望: (41,)
   ```

3. **消融实验**: 待PPO训练完成后运行

---

*文档版本: v0.2*
*更新日期: 2024-01-23*
*状态: 开发中*
